pipeline {
  agent any

  environment {
    BACKEND_IMAGE = "kdk5155/backend"
    FRONTEND_IMAGE = "kdk5155/frontend"
    APP_EC2_USER = "ubuntu"
    APP_EC2_IP = "13.49.125.245"
  }

  stages {
    stage('Checkout Code') {
  steps {
    git branch: 'main', url: 'https://github.com/kushandisnaka/devops_inventory_management_system.git'
  }
}

    stage('Build Backend Docker Image') {
      steps {
        sh 'docker build -t $BACKEND_IMAGE:latest backend/'
      }
    }

    stage('Build Frontend Docker Image') {
      steps {
        sh 'docker build -t $FRONTEND_IMAGE:latest frontend/'
      }
    }

    stage('Push Docker Images') {
      steps {
        withCredentials([string(credentialsId: 'docker_secret', variable: 'dockerhub_creds')]) 
     {
          sh '''
            echo $dockerhub_creds | docker login -u kdk5155 --password-stdin
            docker push $BACKEND_IMAGE:latest
            docker push $FRONTEND_IMAGE:latest
          '''
        }
      }
    }

    stage('Terraform Apply') {
      when { expression { fileExists('terraform/main.tf') } }
      steps {
        sh '''
          cd terraform
          terraform init
          terraform apply -auto-approve
        '''
      }
    }

    stage('Deploy to App EC2') {
      steps {
        sshagent(['app-ec2-key']) {
          sh '''
            ssh -o StrictHostKeyChecking=no $APP_EC2_USER@$APP_EC2_IP "
              docker pull $BACKEND_IMAGE:latest
              docker stop backend || true
              docker rm backend || true
              docker run -d --name backend -p 5000:5000 $BACKEND_IMAGE:latest

              docker pull $FRONTEND_IMAGE:latest
              docker stop frontend || true
              docker rm frontend || true
              docker run -d --name frontend -p 3000:5173 $FRONTEND_IMAGE:latest
            "
          '''
        }
      }
    }
  }
}